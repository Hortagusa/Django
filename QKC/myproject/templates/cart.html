{% extends 'base.html' %}
{% load static %}
{% block body_block %}
<div class="hero-wrap hero-bread" style="background-image: url('{% static 'images/bg_1.jpg' %}');">
	<div class="container">
		<div class="row no-gutters slider-text align-items-center justify-content-center">
			<div class="col-md-9 ftco-animate text-center">
				<p class="breadcrumbs"><span class="mr-2"><a href="index.html">Home</a></span> <span>Cart</span></p>
				<h1 class="mb-0 bread">My Cart</h1>
			</div>
		</div>
	</div>
</div>

<section class="ftco-section ftco-cart">
	<div class="container">
		<div class="row">
			<div class="col-md-12 ftco-animate">
				<div class="cart-list">
					<table class="table">
						<thead class="thead-primary">
							<tr class="text-center">
								<th>&nbsp;</th>
								<th>&nbsp;</th>
								<th>Product name</th>
								<th>Price</th>
								<th>Quantity</th>
								<th>Total</th>
							</tr>
						</thead>
						<tbody id="cart_table_body">
						</tbody>
					</table>
					<div class="row justify-content-end mt-4">
						<div class="col-md-4">
							<div class="cart-total text-right">
								<p class="total-price">
									<span>Total:</span>
									<span id="cart-total">$0.00</span>
								</p>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row justify-content-end">
			<div class="mt-5 cart-wrap ftco-animate">
				<section class="ftco-section">
					<div class="container">
						<div class="row justify-content-center">
							<div class="col-xl-7 ftco-animate">
								<form id="order-form" class="billing-form">
									{% csrf_token %}

									<div class="row">

										<!-- C·ªòT TR√ÅI: BILLING -->
										<div class="col-md-7">
											<h3 class="mb-4 billing-heading">Billing Details</h3>

											<div class="row">
												<div class="col-md-6">
													<label>First Name</label>
													<input id="firstName" class="form-control" />
												</div>

												<div class="col-md-6">
													<label>Last Name</label>
													<input id="lastName" class="form-control" />
												</div>

												<div class="col-md-12 mt-3">
													<label>Address</label>
													<input id="address" class="form-control" />
												</div>

												<div class="col-md-6 mt-3">
													<label>Phone</label>
													<input id="phone" class="form-control" />
												</div>

												<div class="col-md-6 mt-3">
													<label>Email</label>
													<input id="email" class="form-control" />
												</div>
											</div>
										</div>

										<!-- C·ªòT PH·∫¢I: PAYMENT -->
										<div class="col-md-5">
											<div class="cart-detail p-4 border rounded">
												<h3 class="billing-heading mb-4">Payment Method</h3>

												<div class="form-check">
													<input class="form-check-input" type="radio" name="payment" value="bank">
													<label class="form-check-label">Direct Bank Transfer</label>
												</div>

												<div class="form-check">
													<input class="form-check-input" type="radio" name="payment" value="check">
													<label class="form-check-label">Check Payment</label>
												</div>

												<div class="form-check">
													<input class="form-check-input" type="radio" name="payment" value="paypal">
													<label class="form-check-label">Paypal</label>
												</div>

												<div class="form-check mt-3">
													<input class="form-check-input" type="checkbox" id="agreeTerms">
													<label class="form-check-label">
														I have read and accept the terms
													</label>
												</div>

												<button type="submit" id="checkout-btn"
													class="btn btn-primary mt-3 w-100" disabled>
													Place an order
												</button>
											</div>
										</div>

									</div>
								</form>
								<!-- END -->

							</div>

							<!-- .col-md-8 -->
						</div>
					</div>
				</section>
				<!-- .section -->
			</div>
		</div>
	</div>
</section>

<section class="ftco-section ftco-no-pt ftco-no-pb py-5 bg-light">
	<div class="container py-4">
		<div class="row d-flex justify-content-center py-5">
			<div class="col-md-6">
				<h2 style="font-size: 22px;" class="mb-0">Subcribe to our Newsletter</h2>
				<span>Get e-mail updates about our latest shops and special offers</span>
			</div>
			<div class="col-md-6 d-flex align-items-center">
				<form action="#" class="subscribe-form">
					<div class="form-group d-flex">
						<input type="text" class="form-control" placeholder="Enter email address">
						<input type="submit" value="Subscribe" class="submit px-3">
					</div>
				</form>
			</div>
		</div>
	</div>
</section>

<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
	crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
	crossorigin="anonymous"></script>

<!-- Hi·ªÉn th·ªã s·∫£n ph·∫©m -->
<script>
	let cart = JSON.parse(localStorage.getItem("cart")) || {};

	let total = 0;

	for (let item in cart) {
		let qty = cart[item][0];
		let name = cart[item][1];
		let price = cart[item][2];
		let image = cart[item][3];

		let itemTotal = qty * price;
		total += itemTotal;

		let row = `
      <tr class="text-center">
        <td class="product-remove">
          <a href="#" onclick="removeItem('${item}')">
            <span class="ion-ios-close"></span>
          </a>
        </td>

        <td class="image-prod">
		  <img
			src="${image}"
			referrerpolicy="no-referrer"
			style="width:80px;height:80px;object-fit:cover;border-radius:8px"
		  >
		</td>

        <td class="product-name">
          <h3>${name}</h3>
        </td>

        <td class="price">$${price}</td>

        <td class="quantity">
          <input type="number"
            class="form-control text-center"
            value="${qty}"
            min="1"
            onchange="updateQty('${item}', this.value)">
        </td>

        <td class="total">$${itemTotal.toFixed(2)}</td>
      </tr>
    `;

		document.getElementById("cart_table_body").innerHTML += row;
	}

	document.querySelector(".total-price span:last-child").innerText =
		"$" + total.toFixed(2);
</script>

<!-- X√≥a s·∫£n ph·∫©m -->
<script>
	function removeItem(id) {
		let cart = JSON.parse(localStorage.getItem("cart"));
		delete cart[id];
		localStorage.setItem("cart", JSON.stringify(cart));
		location.reload();
	}
</script>

<!-- Update -->
<script>
	function updateQty(id, qty) {
		let cart = JSON.parse(localStorage.getItem("cart"));
		cart[id][0] = parseInt(qty);
		localStorage.setItem("cart", JSON.stringify(cart));
		location.reload();
	}
</script>

<!-- Ki·ªÉm tra tr∆∞·ªõc khi ƒë·∫∑t h√†ng -->
<script>
	function validateCheckout() {
		const firstName = document.getElementById("firstName").value.trim();
		const lastName = document.getElementById("lastName").value.trim();
		const address = document.getElementById("address").value.trim();
		const phone = document.getElementById("phone").value.trim();
		const email = document.getElementById("email").value.trim();

		const payment = document.querySelector('input[name="payment"]:checked');
		const agree = document.getElementById("agreeTerms").checked;

		const btn = document.getElementById("checkout-btn");

		if (
			firstName &&
			lastName &&
			address &&
			phone &&
			email &&
			payment &&
			agree
		) {
			btn.classList.remove("disabled");
			btn.style.pointerEvents = "auto";
			btn.style.opacity = "1";
		} else {
			btn.classList.add("disabled");
			btn.style.pointerEvents = "none";
			btn.style.opacity = "0.6";
		}
	}

	/* L·∫Øng nghe thay ƒë·ªïi */
	document.querySelectorAll(
		"#firstName, #lastName, #address, #phone, #email, input[name='payment'], #agreeTerms"
	).forEach(el => {
		el.addEventListener("input", validateCheckout);
		el.addEventListener("change", validateCheckout);
	});

	/* Click checkout */
	document.getElementById("order-form").addEventListener("submit", function (e) {
		e.preventDefault();

		console.log("‚úÖ FORM SUBMITTED");

		fetch("/cart/", {
			method: "POST",
			headers: {
				"Content-Type": "application/x-www-form-urlencoded",
				"X-CSRFToken": "{{ csrf_token }}"
			},
			body: new URLSearchParams({
				firstName: document.getElementById("firstName").value,
				lastName: document.getElementById("lastName").value,
				address: document.getElementById("address").value,
				phone: document.getElementById("phone").value,
				email: document.getElementById("email").value,
				cart: localStorage.getItem("cart")
			})
		})
			.then(res => res.json())
			.then(data => {
				console.log("üì¶ RESPONSE:", data);
				if (data.success) {
					alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!");
					localStorage.removeItem("cart");
					window.location.href = `/shop/order/${data.order_id}/`;
				}
			})
			.catch(err => console.error("‚ùå ERROR:", err));
	});
</script>
{% endblock %}